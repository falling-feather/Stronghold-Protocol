var gt=Object.defineProperty;var xt=(a,t,s)=>t in a?gt(a,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):a[t]=s;var f=(a,t,s)=>xt(a,typeof t!="symbol"?t+"":t,s);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))i(e);new MutationObserver(e=>{for(const n of e)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function s(e){const n={};return e.integrity&&(n.integrity=e.integrity),e.referrerPolicy&&(n.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?n.credentials="include":e.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(e){if(e.ep)return;e.ep=!0;const n=s(e);fetch(e.href,n)}})();const l={TILE_SIZE:64,MAP_WIDTH:10,MAP_HEIGHT:8,BASE_LIVES:10,BASE_MONEY:15,MAX_BENCH_SIZE:10},H=[{layout:[[2,2,2,2,2,2,2,2,2,2],[3,0,0,0,1,1,1,1,2,2],[2,2,2,0,1,1,1,1,2,2],[2,1,1,0,0,0,0,0,2,2],[2,1,1,2,2,2,2,0,2,2],[2,1,1,1,1,0,0,0,2,2],[2,2,2,2,2,0,2,2,2,2],[2,2,2,2,2,4,2,2,2,2]],waypoints:[{x:0,y:1},{x:3,y:1},{x:3,y:3},{x:3,y:4},{x:7,y:4},{x:7,y:5},{x:5,y:5},{x:5,y:6},{x:5,y:7}]},{layout:[[2,2,2,2,2,2,2,2,2,2],[3,0,0,0,0,0,0,0,0,2],[2,1,1,1,1,1,1,1,1,2],[2,0,0,0,0,0,0,0,0,2],[2,1,1,1,1,1,1,1,1,2],[2,0,0,0,0,0,0,0,0,2],[2,1,1,1,1,1,1,1,1,2],[2,2,2,2,2,2,2,2,4,2]],waypoints:[{x:0,y:1},{x:8,y:1},{x:1,y:3},{x:8,y:3},{x:1,y:5},{x:8,y:5},{x:8,y:7}]},{layout:[[2,2,2,2,2,2,2,2,2,2],[3,0,0,0,0,1,1,1,1,2],[2,1,1,1,1,1,1,1,0,2],[2,0,0,0,0,0,0,0,0,2],[2,1,1,1,1,0,0,0,0,2],[2,0,0,0,0,0,0,1,1,2],[2,1,1,1,1,1,1,1,0,2],[2,2,2,2,2,2,2,2,4,2]],waypoints:[{x:0,y:1},{x:4,y:1},{x:8,y:2},{x:1,y:3},{x:4,y:3},{x:4,y:4},{x:5,y:4},{x:7,y:5},{x:7,y:7}]},{layout:[[2,2,2,2,2,2,2,2,2,2],[3,0,0,0,0,0,0,0,0,2],[2,0,1,1,1,1,1,1,0,2],[2,0,1,0,0,0,0,1,0,2],[2,0,1,0,0,0,0,1,0,2],[2,0,1,0,0,0,0,1,0,2],[2,0,1,1,1,1,1,1,0,2],[2,2,2,2,2,2,2,2,4,2]],waypoints:[{x:0,y:1},{x:2,y:1},{x:2,y:3},{x:7,y:3},{x:7,y:5},{x:2,y:5},{x:2,y:6},{x:8,y:6}]},{layout:[[2,2,2,2,2,2,2,2,2,2],[3,0,0,0,0,0,0,0,0,2],[2,1,1,1,1,1,1,1,1,2],[2,1,1,1,1,1,1,1,1,2],[2,0,0,0,0,0,0,0,0,2],[2,1,1,1,1,1,1,1,1,2],[2,1,1,1,1,1,1,1,1,2],[2,2,2,2,2,2,2,2,4,2]],waypoints:[{x:0,y:1},{x:8,y:1},{x:1,y:4},{x:8,y:4},{x:8,y:7}]},{layout:[[2,2,2,2,2,2,2,2,2,2],[3,0,0,0,1,1,1,1,1,2],[2,1,1,0,0,0,0,0,1,2],[2,1,1,1,1,1,1,0,1,2],[2,0,0,0,0,0,1,0,1,2],[2,0,1,1,1,0,1,0,1,2],[2,0,0,0,0,0,0,0,1,2],[2,2,2,2,2,2,2,2,4,2]],waypoints:[{x:0,y:1},{x:3,y:1},{x:3,y:2},{x:3,y:4},{x:7,y:4},{x:7,y:5},{x:1,y:5},{x:1,y:6},{x:5,y:6},{x:5,y:7},{x:8,y:7}]}];let O=H[0].layout,$=H[0].waypoints;function It(){const a=Math.floor(Math.random()*H.length),t=H[a];return O=t.layout,$=t.waypoints,a}const tt=[[1,0,0,0,0],[.6,.4,0,0,0],[.3,.5,.2,0,0],[.1,.3,.4,.2,0],[0,.1,.3,.4,.2]],_=(a,t,s="auto")=>({name:a,desc:t,initialSp:0,cost:10,spRecovery:s}),I={recruit_guard:{name:"预备近卫",cost:8,rarity:1,color:"#95a5a6",placement:"ground",stats:{hp:1200,maxHp:1200,atk:200,def:50,spd:0,range:1.1,aspd:1.2,blockCount:1},skill:_("强力击·α","下一次攻击力提升至150%","attack"),saleValue:1,shopLevel:0},recruit_defender:{name:"轻装盾兵",cost:10,rarity:2,color:"#7f8c8d",placement:"ground",stats:{hp:2e3,maxHp:2e3,atk:120,def:250,spd:0,range:1,aspd:1.5,blockCount:2},skill:_("防御力强化·α","防御力+10%，持续10秒","defense"),saleValue:1,shopLevel:0},guard_sword:{name:"剑豪",cost:15,rarity:3,color:"#3498db",placement:"ground",stats:{hp:1800,maxHp:1800,atk:450,def:150,spd:0,range:1.2,aspd:1.1,blockCount:1},skill:_("二连击","下一次攻击造成两次伤害","attack"),saleValue:1,shopLevel:1},defender_shield:{name:"重盾卫",cost:18,rarity:3,color:"#2ecc71",placement:"ground",stats:{hp:3500,maxHp:3500,atk:200,def:600,spd:0,range:1,aspd:1.6,blockCount:3},skill:_("龟壳姿态","停止攻击，防御力+50%，回血速度提升","defense"),saleValue:1,shopLevel:1},sniper_aa:{name:"速射手",cost:14,rarity:3,color:"#e67e22",placement:"high_ground",stats:{hp:800,maxHp:800,atk:300,def:50,spd:0,range:3.5,aspd:1,blockCount:0},skill:_("射速爆发","攻击速度+30，持续15秒","auto"),saleValue:1,shopLevel:1},sniper_boom:{name:"炮击手",cost:25,rarity:4,color:"#d35400",placement:"high_ground",stats:{hp:1e3,maxHp:1e3,atk:600,def:80,spd:0,range:4.5,aspd:2.8,blockCount:0},skill:_("爆破弹","下一次攻击造成范围爆炸伤害","attack"),saleValue:1,shopLevel:2},caster_volcano:{name:"天灾术师",cost:35,rarity:5,color:"#9b59b6",placement:"high_ground",stats:{hp:1500,maxHp:1500,atk:750,def:100,spd:0,range:3.5,aspd:1.5,blockCount:0},skill:_("火山","攻击范围大幅扩大，同时攻击6个目标","auto"),saleValue:1,shopLevel:3}},Et={slug:{name:"源石虫",color:"#e74c3c",radius:15,stats:{hp:350,maxHp:350,atk:150,def:0,spd:2.2,range:0,aspd:1,blockCount:0}},soldier:{name:"步兵",color:"#c0392b",radius:18,stats:{hp:1200,maxHp:1200,atk:350,def:100,spd:1.5,range:0,aspd:1.5,blockCount:0}},heavy:{name:"大盾兵",color:"#8e44ad",radius:22,stats:{hp:4500,maxHp:4500,atk:500,def:400,spd:.8,range:0,aspd:2.5,blockCount:0}}},W=[{count:6,interval:1.5,enemyId:"slug",reward:15},{count:10,interval:1.2,enemyId:"slug",reward:20},{count:6,interval:2.5,enemyId:"soldier",reward:30},{count:12,interval:2,enemyId:"soldier",reward:40},{count:4,interval:4,enemyId:"heavy",reward:60}],C=(a,t)=>Math.sqrt(Math.pow(t.x-a.x,2)+Math.pow(t.y-a.y,2)),Tt=a=>{const t=Math.sqrt(a.x*a.x+a.y*a.y);return t===0?{x:0,y:0}:{x:a.x/t,y:a.y/t}},et=(a,t,s)=>{if(C(a,t)<=s)return{...t};const e=Tt({x:t.x-a.x,y:t.y-a.y});return{x:a.x+e.x*s,y:a.y+e.y*s}},bt=(a,t,s,i)=>{const e=Math.max(s.x,Math.min(a.x,s.x+i)),n=Math.max(s.y,Math.min(a.y,s.y+i)),o=a.x-e,r=a.y-n;return o*o+r*r<t*t};function ot(a,t,s,i){const e=[],{x:n,y:o}=a;if(s==="ground")switch(t){case"up":e.push({x:n,y:o-1});break;case"down":e.push({x:n,y:o+1});break;case"left":e.push({x:n-1,y:o});break;case"right":e.push({x:n+1,y:o});break}else{const r=i>=4.5?5:3,d=i>=4.5?6:4;switch(t){case"up":for(let h=0;h<d;h++)for(let u=-Math.floor(r/2);u<=Math.floor(r/2);u++)e.push({x:n+u,y:o-h});break;case"down":for(let h=0;h<d;h++)for(let u=-Math.floor(r/2);u<=Math.floor(r/2);u++)e.push({x:n+u,y:o+h});break;case"left":for(let h=0;h<d;h++)for(let u=-Math.floor(r/2);u<=Math.floor(r/2);u++)e.push({x:n-h,y:o+u});break;case"right":for(let h=0;h<d;h++)for(let u=-Math.floor(r/2);u<=Math.floor(r/2);u++)e.push({x:n+h,y:o+u});break}}return e.filter(r=>r.x>=0&&r.x<10&&r.y>=0&&r.y<8)}function vt(a,t,s,i,e,n){const o=ot(a,t,s,i),r=Math.floor(e.x/n),d=Math.floor(e.y/n);return o.some(h=>h.x===r&&h.y===d)}class St{constructor(){f(this,"enemies",[]);f(this,"operators",[]);f(this,"bench",[]);f(this,"projectiles",[]);f(this,"phase","PREP");f(this,"money",l.BASE_MONEY);f(this,"lives",l.BASE_LIVES);f(this,"waveIndex",0);f(this,"coreLevel",1);f(this,"shopItems",[]);f(this,"operatorPool",new Map);f(this,"isInTemporaryShop",!1);f(this,"temporaryShopItems",[]);f(this,"pendingDeployment",null);f(this,"onStateUpdated",null);f(this,"enemiesToSpawn",0);f(this,"spawnTimer",0);f(this,"spawnInterval",0);f(this,"currentEnemyId","");f(this,"currentWaveReward",0);f(this,"combatTimeLimit",0);f(this,"combatTimeRemaining",0);f(this,"totalEnemiesInWave",0);f(this,"killedEnemiesInWave",0);this.refreshShop(!0)}update(t){if(this.phase==="COMBAT"){if(this.combatTimeRemaining-=t,this.combatTimeRemaining<=0){this.handleTimeUp();return}this.handleSpawning(t),this.updateBlocking(),this.updateEnemies(t),this.updateOperators(t),this.updateProjectiles(t)}this.cleanup(),this.phase==="COMBAT"&&this.checkCombatEnd()}handleTimeUp(){const t=this.totalEnemiesInWave-this.killedEnemiesInWave;if(this.lives-=t,this.enemies.forEach(s=>s.markedForDeletion=!0),this.enemiesToSpawn=0,this.lives<=0){this.phase="PREP",this.notifyUpdate();return}this.endCombat()}notifyUpdate(){this.onStateUpdated&&this.onStateUpdated()}tryStartCombat(){if(this.phase==="COMBAT"||this.money>0&&!window.confirm(`还有 资金 ${this.money} 未花费。
战斗开始将回收资金！
确认开始？`))return!1;if(this.waveIndex<W.length){const t=W[this.waveIndex];this.enemiesToSpawn=t.count,this.spawnInterval=t.interval,this.currentEnemyId=t.enemyId,this.currentWaveReward=t.reward;const s=Math.min(this.waveIndex/W.length,1);return this.combatTimeLimit=90-s*30,this.combatTimeRemaining=this.combatTimeLimit,this.totalEnemiesInWave=t.count,this.killedEnemiesInWave=0,this.money=0,this.phase="COMBAT",this.notifyUpdate(),!0}else return alert("全域威胁已清除！"),!1}checkCombatEnd(){this.phase==="COMBAT"&&this.enemiesToSpawn<=0&&this.enemies.length===0&&this.endCombat()}endCombat(){this.phase="PREP",this.waveIndex++,this.money+=this.currentWaveReward,this.combatTimeRemaining=0,this.combatTimeLimit=0,this.operators.forEach(t=>{t.stats.hp=t.stats.maxHp,t.isRetreated=!1,t.blockingEnemyIds=[]}),setTimeout(()=>{alert(`=== 第 ${this.waveIndex} 波次完成 ===
获得资金: ${this.currentWaveReward}`),this.refreshShop(!0),this.notifyUpdate()},100)}refreshShop(t=!1){if(this.isInTemporaryShop){alert("请先完成临时商店的选择！");return}const s=2;if(!t){if(this.phase!=="PREP"||this.money<s)return;this.money-=s}this.shopItems=[];const i=3+(this.coreLevel>=3?1:0)+(this.coreLevel>=5?1:0);let e=0;const n=i*10;for(let o=0;o<i&&e<n;e++){const r=this.rollForOperator(),d=I[r],h=this.operatorPool.get(r);h&&h.count>=7||(this.shopItems.push({uid:`shop_${Date.now()}_${o}`,templateId:r,cost:d.cost,bought:!1}),o++)}this.notifyUpdate()}rollForOperator(){const t=Math.min(this.coreLevel-1,tt.length-1),s=tt[t],i=Math.random();let e=0,n=1;for(let r=0;r<s.length;r++)if(e+=s[r],i<=e){n=r+1;break}const o=Object.entries(I).filter(([r,d])=>d.rarity===n).map(([r,d])=>r);return o.length===0?Object.keys(I)[0]:o[Math.floor(Math.random()*o.length)]}upgradeCore(){const t=this.coreLevel*10;this.money>=t&&this.coreLevel<5&&(this.money-=t,this.coreLevel++,this.refreshShop(!0))}tryBuyOperator(t){if(this.phase!=="PREP")return!1;if(this.isInTemporaryShop)return this.tryBuyTemporaryShop(t);const s=this.shopItems.find(n=>n.uid===t);if(!s||s.bought||!I[s.templateId])return!1;const e=this.operatorPool.get(s.templateId);return e&&e.count>=7?(alert("该角色已达到最大获取次数！"),!1):this.money<s.cost?!1:this.bench.length>=l.MAX_BENCH_SIZE?(alert("备战区已满！"),!1):(this.money-=s.cost,s.bought=!0,e?(e.count++,e.rank1Count++):this.operatorPool.set(s.templateId,{count:1,rank1Count:1,rank2Count:0}),this.bench.push({uid:`bench_${Date.now()}_${Math.random()}`,templateId:s.templateId,rank:1}),this.checkAndMergeOperators(s.templateId),this.notifyUpdate(),!0)}tryBuyTemporaryShop(t){const s=this.temporaryShopItems.find(n=>n.uid===t);if(!s||s.bought)return!1;if(this.bench.length>=l.MAX_BENCH_SIZE)return alert("备战区已满！"),!1;if(s.bought=!0,!I[s.templateId])return!1;const e=this.operatorPool.get(s.templateId);return e?(e.count++,e.rank1Count++):this.operatorPool.set(s.templateId,{count:1,rank1Count:1,rank2Count:0}),this.bench.push({uid:`bench_${Date.now()}_${Math.random()}`,templateId:s.templateId,rank:1}),this.exitTemporaryShop(),this.notifyUpdate(),!0}checkAndMergeOperators(t){const s=this.operatorPool.get(t);if(!s||s.rank1Count<3)return;this.operators.filter(n=>n.templateId===t&&n.rank===1).forEach(n=>{this.recallOperator(n.id)});const e=this.bench.filter(n=>n.templateId===t&&n.rank===1);if(e.length>=3){for(let n=0;n<3;n++){const o=this.bench.findIndex(r=>r.uid===e[n].uid);o!==-1&&this.bench.splice(o,1)}this.bench.push({uid:`bench_${Date.now()}_${Math.random()}`,templateId:t,rank:2}),s.rank1Count-=3,s.rank2Count+=1,this.enterTemporaryShop(t)}}enterTemporaryShop(t){const s=I[t];if(!s)return;const i=s.shopLevel+1,e=Object.entries(I).filter(([,r])=>r.shopLevel===i).map(([r])=>r);if(e.length===0){alert("自动合并完成！但暂时没有更高等级的角色可用。");return}const n=Math.min(3+Math.floor(Math.random()*2),e.length),o=[...e].sort(()=>Math.random()-.5);this.temporaryShopItems=[];for(let r=0;r<n;r++){const d=o[r];this.temporaryShopItems.push({uid:`temp_shop_${Date.now()}_${r}`,templateId:d,cost:0,bought:!1})}this.isInTemporaryShop=!0,alert(`自动合并完成！获得2阶${s.name}！
进入临时商店，可免费获得一个角色。`),this.notifyUpdate()}exitTemporaryShop(){this.isInTemporaryShop=!1,this.temporaryShopItems=[]}sellBenchOperator(t){const s=this.bench.findIndex(n=>n.uid===t);if(s===-1)return!1;const i=this.bench[s],e=I[i.templateId];return this.bench.splice(s,1),this.money+=e.saleValue,this.notifyUpdate(),!0}recallOperator(t){const s=this.operators.findIndex(e=>e.id===t);if(s===-1)return!1;if(this.bench.length>=l.MAX_BENCH_SIZE)return alert("备战区已满，无法撤回！"),!1;const i=this.operators[s];return i.blockingEnemyIds.forEach(e=>{const n=this.enemies.find(o=>o.id===e);n&&(n.isBlockedBy=null)}),this.operators.splice(s,1),this.bench.push({uid:`bench_${Date.now()}_${Math.random()}`,templateId:i.templateId,rank:i.rank||1}),this.notifyUpdate(),!0}tryPlaceOperator(t,s,i){if(this.phase!=="PREP"||s<0||s>=l.MAP_WIDTH||i<0||i>=l.MAP_HEIGHT||this.operators.some(d=>d.gridPos.x===s&&d.gridPos.y===i))return!1;const e=this.bench.findIndex(d=>d.uid===t);if(e===-1)return!1;const n=this.bench[e],o=I[n.templateId],r=O[i][s];return o.placement==="high_ground"&&r!==1||o.placement==="ground"&&r!==0?!1:(this.pendingDeployment={benchUid:t,gridX:s,gridY:i,templateId:n.templateId,rank:n.rank||1},this.notifyUpdate(),!0)}confirmDeployment(t){if(!this.pendingDeployment)return!1;const{benchUid:s,gridX:i,gridY:e,templateId:n,rank:o}=this.pendingDeployment,r=this.bench.findIndex(h=>h.uid===s);if(r===-1)return this.pendingDeployment=null,!1;const d=I[n];return this.bench.splice(r,1),this.operators.push({id:`op_${Date.now()}`,templateId:n,pos:{x:i*l.TILE_SIZE,y:e*l.TILE_SIZE},gridPos:{x:i,y:e},radius:l.TILE_SIZE,color:d.color,stats:{...d.stats},name:d.name,cooldown:0,targetId:null,cost:d.cost,placement:d.placement,rarity:d.rarity,markedForDeletion:!1,blockingEnemyIds:[],isRetreated:!1,skill:{...d.skill},currentSp:d.skill.initialSp,skillActive:!1,skillDuration:0,rank:o,direction:t}),this.pendingDeployment=null,this.notifyUpdate(),!0}cancelPendingDeployment(){this.pendingDeployment=null,this.notifyUpdate()}updateBlocking(){this.enemies.forEach(t=>{if(t.isBlockedBy){const i=this.operators.find(e=>e.id===t.isBlockedBy);(!i||i.markedForDeletion||i.isRetreated)&&(t.isBlockedBy=null);return}const s=this.operators.filter(i=>!i.isRetreated&&i.placement==="ground"&&i.blockingEnemyIds.length<i.stats.blockCount&&bt(t.pos,t.radius,i.pos,l.TILE_SIZE));if(s.length>0){const i=s[0];i.blockingEnemyIds.push(t.id),t.isBlockedBy=i.id}})}handleSpawning(t){this.enemiesToSpawn>0&&(this.spawnTimer+=t,this.spawnTimer>=this.spawnInterval&&(this.spawnEnemy(),this.spawnTimer=0,this.enemiesToSpawn--))}spawnEnemy(){const t=Et[this.currentEnemyId],s=$[0];this.enemies.push({id:`en_${Date.now()}`,pos:{x:s.x*l.TILE_SIZE+l.TILE_SIZE/2,y:s.y*l.TILE_SIZE+l.TILE_SIZE/2},gridPos:{x:s.x,y:s.y},radius:t.radius,color:t.color,stats:{...t.stats},waypointIndex:0,markedForDeletion:!1,isBlockedBy:null,attackCooldown:0})}updateEnemies(t){this.enemies.forEach(s=>{if(s.isBlockedBy){const n=this.operators.find(o=>o.id===s.isBlockedBy);if(n&&!n.isRetreated&&(s.attackCooldown-=t,s.attackCooldown<=0)){const o=Math.max(10,s.stats.atk-n.stats.def);n.stats.hp-=o;const r=n.skill.spRecovery;(r==="defense"||r==="auto_defense"||r==="attack_defense"||r==="all")&&(n.currentSp=Math.min(n.skill.cost,n.currentSp+1)),s.attackCooldown=s.stats.aspd,n.stats.hp<=0&&this.handleOperatorRetreat(n)}return}const i=$[s.waypointIndex+1];if(!i){this.lives-=1,s.markedForDeletion=!0;return}const e={x:i.x*l.TILE_SIZE+l.TILE_SIZE/2,y:i.y*l.TILE_SIZE+l.TILE_SIZE/2};s.pos=et(s.pos,e,s.stats.spd*60*t),C(s.pos,e)<5&&s.waypointIndex++})}handleOperatorRetreat(t){t.isRetreated=!0,t.stats.hp=0,t.blockingEnemyIds.forEach(s=>{const i=this.enemies.find(e=>e.id===s);i&&(i.isBlockedBy=null)}),t.blockingEnemyIds=[]}updateOperators(t){this.operators.forEach(s=>{if(s.isRetreated)return;s.cooldown=Math.max(0,s.cooldown-t);const i=s.skill.spRecovery;if((i==="auto"||i==="auto_attack"||i==="auto_defense"||i==="all")&&(s.currentSp=Math.min(s.skill.cost,s.currentSp+t)),s.cooldown<=0){let e=null;if(s.blockingEnemyIds.length>0&&(e=this.enemies.find(n=>n.id===s.blockingEnemyIds[0])||null),!e){let n=1/0;this.enemies.forEach(o=>{if(vt(s.gridPos,s.direction,s.placement,s.stats.range,o.pos,l.TILE_SIZE)){const r={x:s.pos.x+l.TILE_SIZE/2,y:s.pos.y+l.TILE_SIZE/2},d=C(r,o.pos);d<n&&(n=d,e=o)}})}e&&(this.fireProjectile(s,e),s.cooldown=s.stats.aspd)}})}fireProjectile(t,s){const i={x:t.pos.x+l.TILE_SIZE/2,y:t.pos.y+l.TILE_SIZE/2};this.projectiles.push({id:`proj_${Date.now()}_${Math.random()}`,pos:i,targetId:s.id,speed:600,damage:t.stats.atk,color:"#fff",markedForDeletion:!1});const e=t.skill.spRecovery;(e==="attack"||e==="auto_attack"||e==="attack_defense"||e==="all")&&(t.currentSp=Math.min(t.skill.cost,t.currentSp+1))}updateProjectiles(t){this.projectiles.forEach(s=>{const i=this.enemies.find(e=>e.id===s.targetId);if(!i||i.markedForDeletion){s.markedForDeletion=!0;return}if(s.pos=et(s.pos,i.pos,s.speed*t),C(s.pos,i.pos)<15&&(i.stats.hp-=s.damage,s.markedForDeletion=!0,i.stats.hp<=0&&!i.markedForDeletion&&(i.markedForDeletion=!0,this.killedEnemiesInWave++,i.isBlockedBy))){const e=this.operators.find(n=>n.id===i.isBlockedBy);e&&(e.blockingEnemyIds=e.blockingEnemyIds.filter(n=>n!==i.id))}})}cleanup(){this.enemies=this.enemies.filter(t=>!t.markedForDeletion),this.projectiles=this.projectiles.filter(t=>!t.markedForDeletion),this.lives<=0&&(alert("任务失败！页面将刷新。"),location.reload())}}class kt{constructor(t){f(this,"ctx");f(this,"canvas");this.canvas=t,this.ctx=t.getContext("2d"),this.resize()}resize(){if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||window.innerWidth<=768){const s=this.canvas.parentElement;if(s){const i=s.clientWidth,e=s.clientHeight,n=l.MAP_WIDTH*l.TILE_SIZE/(l.MAP_HEIGHT*l.TILE_SIZE);i/e>n?(this.canvas.height=e,this.canvas.width=e*n):(this.canvas.width=i,this.canvas.height=i/n)}}else this.canvas.width=l.MAP_WIDTH*l.TILE_SIZE,this.canvas.height=l.MAP_HEIGHT*l.TILE_SIZE}render(t,s,i){this.ctx.fillStyle="#1a1a1a",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.drawMap(),this.drawPathGuide(),t.pendingDeployment?this.drawPendingDeployment(t,i):s&&this.drawPlacementOverlay(t,s),t.operators.forEach(e=>this.drawOperator(e)),t.enemies.forEach(e=>this.drawEnemy(e)),t.projectiles.forEach(e=>this.drawProjectile(e))}drawMap(){for(let t=0;t<l.MAP_HEIGHT;t++)for(let s=0;s<l.MAP_WIDTH;s++){const i=O[t][s],e=s*l.TILE_SIZE,n=t*l.TILE_SIZE;switch(i){case 0:this.ctx.fillStyle="#34495e";break;case 1:this.ctx.fillStyle="#95a5a6";break;case 2:this.ctx.fillStyle="#2c3e50";break;case 3:this.ctx.fillStyle="rgba(231, 76, 60, 0.2)";break;case 4:this.ctx.fillStyle="rgba(52, 152, 219, 0.2)";break}this.ctx.fillRect(e,n,l.TILE_SIZE,l.TILE_SIZE),this.ctx.strokeStyle="#222",this.ctx.strokeRect(e,n,l.TILE_SIZE,l.TILE_SIZE),i===3&&(this.ctx.fillStyle="#e74c3c",this.ctx.font="bold 16px Arial",this.ctx.fillText("IN",e+22,n+38)),i===4&&(this.ctx.fillStyle="#3498db",this.ctx.font="bold 16px Arial",this.ctx.fillText("OUT",e+15,n+38))}}drawPathGuide(){this.ctx.strokeStyle="rgba(255,255,255,0.05)",this.ctx.lineWidth=10,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.beginPath(),$.forEach((t,s)=>{const i=t.x*l.TILE_SIZE+l.TILE_SIZE/2,e=t.y*l.TILE_SIZE+l.TILE_SIZE/2;s===0?this.ctx.moveTo(i,e):this.ctx.lineTo(i,e)}),this.ctx.stroke()}drawOperator(t){const i=l.TILE_SIZE-12;if(t.isRetreated?(this.ctx.fillStyle="#555",this.ctx.globalAlpha=.5):(this.ctx.fillStyle=t.color,this.ctx.globalAlpha=1),this.ctx.fillRect(t.pos.x+6,t.pos.y+6,i,i),this.ctx.globalAlpha=1,!t.isRetreated&&t.direction){this.ctx.strokeStyle="#fff",this.ctx.lineWidth=2,this.ctx.beginPath();const e=t.pos.x+l.TILE_SIZE/2,n=t.pos.y+l.TILE_SIZE/2,o=8;switch(t.direction){case"up":this.ctx.moveTo(e,n-o),this.ctx.lineTo(e-o/2,n),this.ctx.moveTo(e,n-o),this.ctx.lineTo(e+o/2,n);break;case"down":this.ctx.moveTo(e,n+o),this.ctx.lineTo(e-o/2,n),this.ctx.moveTo(e,n+o),this.ctx.lineTo(e+o/2,n);break;case"left":this.ctx.moveTo(e-o,n),this.ctx.lineTo(e,n-o/2),this.ctx.moveTo(e-o,n),this.ctx.lineTo(e,n+o/2);break;case"right":this.ctx.moveTo(e+o,n),this.ctx.lineTo(e,n-o/2),this.ctx.moveTo(e+o,n),this.ctx.lineTo(e,n+o/2);break}this.ctx.stroke()}if(this.ctx.fillStyle="#fff",this.ctx.font="10px Arial",this.ctx.fillText(t.name,t.pos.x+10,t.pos.y+20),(t.stats.hp<t.stats.maxHp||t.isRetreated)&&(this.ctx.fillStyle="#333",this.ctx.fillRect(t.pos.x+6,t.pos.y-10,i,4),!t.isRetreated)){this.ctx.fillStyle="#2ecc71";const e=Math.max(0,t.stats.hp/t.stats.maxHp);this.ctx.fillRect(t.pos.x+6,t.pos.y-10,i*e,4)}if(t.isRetreated)this.ctx.fillStyle="#e74c3c",this.ctx.font="bold 12px Arial",this.ctx.fillText("RETREAT",t.pos.x+6,t.pos.y+i/2+4);else{this.ctx.fillStyle="#333",this.ctx.fillRect(t.pos.x+6,t.pos.y-6,i,4),this.ctx.fillStyle="#ff9500";const e=Math.min(1,t.currentSp/t.skill.cost);this.ctx.fillRect(t.pos.x+6,t.pos.y-6,i*e,4),this.ctx.fillStyle="#ecf0f1",this.ctx.font="10px Arial";const n=`B:${t.blockingEnemyIds.length}/${t.stats.blockCount}`;this.ctx.fillText(n,t.pos.x+10,t.pos.y+i)}}drawEnemy(t){this.ctx.save(),this.ctx.translate(t.pos.x,t.pos.y),this.ctx.fillStyle=t.color,this.ctx.beginPath(),this.ctx.arc(0,0,t.radius,0,Math.PI*2),this.ctx.fill(),t.isBlockedBy&&(this.ctx.strokeStyle="#fff",this.ctx.lineWidth=2,this.ctx.stroke()),this.ctx.fillStyle="red",this.ctx.fillRect(-12,-22,24,4),this.ctx.fillStyle="#e67e22",this.ctx.fillRect(-12,-22,24*(t.stats.hp/t.stats.maxHp),4),this.ctx.restore()}drawProjectile(t){this.ctx.fillStyle=t.color,this.ctx.beginPath(),this.ctx.arc(t.pos.x,t.pos.y,4,0,Math.PI*2),this.ctx.fill()}drawPlacementOverlay(t,s){const i=I[s];if(!i)return;const e=i.placement==="ground"?0:1;this.ctx.fillStyle="rgba(46, 204, 113, 0.3)";for(let n=0;n<l.MAP_HEIGHT;n++)for(let o=0;o<l.MAP_WIDTH;o++){const r=O[n][o]===e,d=t.operators.some(h=>h.gridPos.x===o&&h.gridPos.y===n);r&&!d&&(this.ctx.fillRect(o*l.TILE_SIZE,n*l.TILE_SIZE,l.TILE_SIZE,l.TILE_SIZE),this.ctx.strokeStyle="#2ecc71",this.ctx.lineWidth=2,this.ctx.strokeRect(o*l.TILE_SIZE,n*l.TILE_SIZE,l.TILE_SIZE,l.TILE_SIZE))}}drawPendingDeployment(t,s){if(!t.pendingDeployment)return;const{gridX:i,gridY:e,templateId:n}=t.pendingDeployment,o=I[n];if(!o)return;const r=s||"down",d=6,h=l.TILE_SIZE-d*2,u=i*l.TILE_SIZE,g=e*l.TILE_SIZE;this.ctx.fillStyle=o.color,this.ctx.globalAlpha=.6,this.ctx.fillRect(u+d,g+d,h,h),this.ctx.globalAlpha=1,this.ctx.strokeStyle="#fff",this.ctx.lineWidth=2,this.ctx.beginPath();const m=u+l.TILE_SIZE/2,p=g+l.TILE_SIZE/2,E=12;switch(r){case"up":this.ctx.moveTo(m,p-E),this.ctx.lineTo(m-E/2,p),this.ctx.moveTo(m,p-E),this.ctx.lineTo(m+E/2,p);break;case"down":this.ctx.moveTo(m,p+E),this.ctx.lineTo(m-E/2,p),this.ctx.moveTo(m,p+E),this.ctx.lineTo(m+E/2,p);break;case"left":this.ctx.moveTo(m-E,p),this.ctx.lineTo(m,p-E/2),this.ctx.moveTo(m-E,p),this.ctx.lineTo(m,p+E/2);break;case"right":this.ctx.moveTo(m+E,p),this.ctx.lineTo(m,p-E/2),this.ctx.moveTo(m+E,p),this.ctx.lineTo(m,p+E/2);break}this.ctx.stroke();const yt=ot({x:i,y:e},r,o.placement,o.stats.range);this.ctx.fillStyle="rgba(255, 200, 0, 0.3)",yt.forEach(R=>{this.ctx.fillRect(R.x*l.TILE_SIZE,R.y*l.TILE_SIZE,l.TILE_SIZE,l.TILE_SIZE),this.ctx.strokeStyle="rgba(255, 200, 0, 0.8)",this.ctx.lineWidth=2,this.ctx.strokeRect(R.x*l.TILE_SIZE,R.y*l.TILE_SIZE,l.TILE_SIZE,l.TILE_SIZE)})}}let X,x,U,y=null,c=null,k=null,at,rt,lt,G,ct,z,A,Z,q,K,dt,b,V,j,v=null,S=null,P=!1,w=null,T=null,J=0,D=null,B=!1,M=null;function wt(){var a,t,s;y=document.getElementById("game-canvas"),at=document.getElementById("wave-display"),rt=document.getElementById("lives-display"),lt=document.getElementById("money-display"),G=document.getElementById("core-display"),ct=document.getElementById("timer-display"),z=document.getElementById("timer-box"),A=document.getElementById("bench-area"),Z=document.getElementById("shop-cards"),q=document.getElementById("bottom-area"),K=document.getElementById("detail-panel"),dt=document.getElementById("detail-content"),b=document.getElementById("btn-action-main"),V=document.getElementById("btn-upgrade"),j=document.getElementById("txt-upgrade-cost"),It(),c=new St,k=new kt(y),c.onStateUpdated=()=>{st()},st(),J=performance.now(),requestAnimationFrame(mt),(a=document.getElementById("btn-next-wave"))==null||a.addEventListener("click",()=>c.tryStartCombat()),(t=document.getElementById("btn-refresh"))==null||t.addEventListener("click",()=>c.refreshShop()),(s=document.getElementById("btn-upgrade"))==null||s.addEventListener("click",()=>c.upgradeCore()),setTimeout(()=>{F(),k&&k.resize()},100),window.addEventListener("resize",()=>{F(),k&&ht()&&setTimeout(()=>{k&&k.resize()},50)}),window.addEventListener("orientationchange",()=>{setTimeout(()=>{F(),k&&k.resize()},200)}),Lt(),X&&(X.style.display="none"),x&&(x.style.display="flex")}function ht(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||window.innerWidth<=768}function pt(){if(!x)return;const a=document.getElementById("top-bar"),t=document.getElementById("bottom-area");!a||!t||(x.style.transform="none",x.style.width="100%",x.style.height="100%",requestAnimationFrame(()=>{requestAnimationFrame(()=>{if(!a||!t)return;const s=a.offsetHeight||50,i=t.offsetHeight||220,e=window.innerHeight-s-i,n=400;let o=1;if(e<n){const r=s+i+n;o=window.innerHeight/r}o<1?(x.style.transform=`scale(${o})`,x.style.transformOrigin="top center",x.style.width=`${100/o}%`,x.style.height=`${100/o}%`):(x.style.transform="none",x.style.width="100%",x.style.height="100%")})}))}function F(){const a=document.getElementById("mobile-overlay"),t=ht();document.documentElement&&(t?(document.documentElement.classList.add("mobile-rotated"),a.style.display="none"):(document.documentElement.classList.remove("mobile-rotated"),a.style.display="none")),x&&x.style.display!=="none"&&setTimeout(()=>{pt()},100)}function st(){if(!c)return;at.innerText=(c.waveIndex+1).toString(),rt.innerText=c.lives.toString(),lt.innerText=Math.floor(c.money).toString(),G&&(G.innerText=c.coreLevel.toString()),c.phase==="COMBAT"?(q.classList.add("hidden"),z.style.display="block",ct.innerText=Math.ceil(c.combatTimeRemaining).toString(),(v==="shop"||v==="bench")&&L()):(q.classList.remove("hidden"),z.style.display="none"),_t(),Mt(),ft();const a=c.coreLevel*10;c.coreLevel>=5?(j.innerText="MAX",V.disabled=!0):(j.innerText=`资金 ${a}`,V.disabled=!1),setTimeout(()=>{pt()},50)}function mt(a){if(!c||!k)return;const t=(a-J)/1e3;J=a,c.update(t);let s=null;if(P&&w){const e=c.bench.find(n=>n.uid===w);e&&(s=e.templateId)}else if(v==="shop"&&S){const e=c.shopItems.find(n=>n.uid===S);e&&(s=e.templateId)}else if(v==="bench"&&S){const e=c.bench.find(n=>n.uid===S);e&&(s=e.templateId)}let i=null;if(c.pendingDeployment&&D){const e=c.pendingDeployment,n=D.x-e.gridX,o=D.y-e.gridY;Math.abs(n)>Math.abs(o)?i=n>0?"right":"left":o!==0?i=o>0?"down":"up":i="down"}k.render(c,s,i),requestAnimationFrame(mt)}function Lt(){document.addEventListener("click",a=>{const t=a.target;if(t&&t.closest("#start-screen")||!c)return;(!(t&&(t.closest("#detail-panel")||t.closest("button")||t.closest("#top-bar")||t.closest("#bottom-area")||t.closest(".shop-card")||t.closest(".bench-card")))||t.id==="game-canvas")&&(L(),c&&c.pendingDeployment&&c.cancelPendingDeployment())}),y.addEventListener("mousemove",a=>{if(!c||!y)return;const t=y.getBoundingClientRect(),s=y.width/t.width,i=y.height/t.height,e=(a.clientX-t.left)*s,n=(a.clientY-t.top)*i;D={x:Math.floor(e/l.TILE_SIZE),y:Math.floor(n/l.TILE_SIZE)}}),y.addEventListener("mousedown",a=>{if(!c||!y||c.phase!=="PREP"||!c.pendingDeployment)return;const t=y.getBoundingClientRect(),s=y.width/t.width,i=y.height/t.height,e=(a.clientX-t.left)*s,n=(a.clientY-t.top)*i,o=Math.floor(e/l.TILE_SIZE),r=Math.floor(n/l.TILE_SIZE),d=c.pendingDeployment;if(o===d.gridX&&r===d.gridY){B=!0,M={x:o,y:r},P=!0,T=document.createElement("div"),T.className="drag-ghost",T.innerText="设置朝向",T.style.backgroundColor="rgba(255, 200, 0, 0.8)",document.body.appendChild(T),Y(a);const h=g=>{let m,p;g instanceof MouseEvent?(m=g.clientX,p=g.clientY):(m=g.touches[0].clientX,p=g.touches[0].clientY),Y({clientX:m,clientY:p})},u=g=>{let m,p;g instanceof MouseEvent?(m=g.clientX,p=g.clientY):(m=g.changedTouches[0].clientX,p=g.changedTouches[0].clientY),ut(m,p),document.removeEventListener("mousemove",h),document.removeEventListener("mouseup",u),document.removeEventListener("touchmove",h),document.removeEventListener("touchend",u)};document.addEventListener("mousemove",h),document.addEventListener("mouseup",u),document.addEventListener("touchmove",h,{passive:!1}),document.addEventListener("touchend",u)}}),y.addEventListener("click",a=>{if(!c||(a.stopPropagation(),P))return;const t=y.getBoundingClientRect(),s=y.width/t.width,i=y.height/t.height,e=(a.clientX-t.left)*s,n=(a.clientY-t.top)*i,o=Math.floor(e/l.TILE_SIZE),r=Math.floor(n/l.TILE_SIZE);if(c.pendingDeployment){const h=c.pendingDeployment;(o!==h.gridX||r!==h.gridY)&&c.cancelPendingDeployment();return}const d=c.operators.find(h=>h.gridPos.x===o&&h.gridPos.y===r);d?Q("map",d.id):L()})}function _t(){if(!c)return;if(Z.innerHTML="",(c.isInTemporaryShop?c.temporaryShopItems:c.shopItems).forEach(t=>{const s=I[t.templateId],i=document.createElement("div");i.className=`shop-card ${t.bought?"bought":""} ${v==="shop"&&S===t.uid?"selected":""}`,c.isInTemporaryShop&&(i.style.border="3px solid #f1c40f"),i.innerHTML=`
      <div class="shop-name">${s.name}</div>
      <div class="shop-stars">${"★".repeat(s.rarity)}</div>
      <div class="shop-cost">${t.cost===0?"免费":t.cost}</div>
    `,i.onclick=e=>{e.stopPropagation(),t.bought||Q("shop",t.uid)},Z.appendChild(i)}),c.isInTemporaryShop){const t=document.createElement("div");t.style.width="100%",t.style.textAlign="center",t.style.color="#f1c40f",t.style.fontSize="12px",t.style.marginTop="10px",t.innerText="临时商店 - 选择一个免费角色",Z.appendChild(t)}}function Mt(){if(!c)return;A.innerHTML="";for(let t=0;t<l.MAX_BENCH_SIZE;t++){const s=document.createElement("div");if(s.className="bench-slot",t<c.bench.length){const i=c.bench[t],e=I[i.templateId],n=document.createElement("div");n.className=`bench-card ${v==="bench"&&S===i.uid?"selected":""}`,n.style.background=e.color,n.style.color="#fff",n.innerText=e.name,n.onclick=o=>{o.stopPropagation(),c.phase==="PREP"&&Q("bench",i.uid)},n.onmousedown=o=>{o.stopPropagation(),c.phase==="PREP"&&nt(o,i.uid,e.name,e.color)},n.ontouchstart=o=>{if(o.stopPropagation(),c.phase==="PREP"){const r=o.touches[0];nt({clientX:r.clientX,clientY:r.clientY},i.uid,e.name,e.color)}},s.appendChild(n)}else s.innerText="空置";A.appendChild(s)}const a=document.createElement("div");a.className="bench-slot sell-zone",a.innerText="出售",A.appendChild(a)}function Q(a,t){v=a,S=t,ft(),K.classList.add("visible")}function L(){v=null,S=null,K.classList.remove("visible")}function ft(){if(!c||!v||!S)return;let a=null,t=null;if(b.style.display="block",b.className="",b.disabled=!1,v==="shop"){const n=(c.isInTemporaryShop?c.temporaryShopItems:c.shopItems).find(r=>r.uid===S);if(!n)return;a=I[n.templateId];const o=n.cost===0?"免费":n.cost.toString();b.innerText=`购买 (${o})`,b.disabled=(c.isInTemporaryShop?!1:c.money<n.cost)||c.bench.length>=l.MAX_BENCH_SIZE,b.onclick=()=>{c.tryBuyOperator(n.uid)&&L()}}else if(v==="bench"){const e=c.bench.find(n=>n.uid===S);if(!e){L();return}a=I[e.templateId],b.style.display="none"}else if(v==="map"){const e=c.operators.find(n=>n.id===S);if(!e){L();return}a=I[e.templateId],t=e,b.innerText="撤回 (Recall)",b.className="recall",b.disabled=c.phase!=="PREP",b.onclick=()=>{c.phase==="PREP"&&c.recallOperator(e.id)&&L()}}const s=t?Math.floor(t.stats.hp):a.stats.hp,i=a.stats.maxHp;dt.innerHTML=`
    <div class="detail-header">${a.name}</div>
    <div class="detail-sub">${"★".repeat(a.rarity)} / ${a.placement==="ground"?"地面":"高台"}</div>
    
    <div class="detail-stats">
      <div class="stat-row">生命: ${s} / ${i}</div>
      <div class="stat-row">攻击: ${a.stats.atk}</div>
      <div class="stat-row">防御: ${a.stats.def}</div>
      <div class="stat-row">阻挡: ${a.stats.blockCount}</div>
      <div class="stat-row">攻速: ${a.stats.aspd}s</div>
      <div class="stat-row">费用: ${a.cost}</div>
    </div>

    <div class="skill-section">
      <div class="skill-name">技能: ${a.skill.name}</div>
      <div class="skill-desc">${a.skill.desc}</div>
      <div style="margin-top:5px; font-size:12px; color:#bdc3c7;">
        消耗: ${a.skill.cost} / 初始: ${a.skill.initialSp}
      </div>
    </div>
  `}function nt(a,t,s,i){P=!0,w=t,B=!1,L(),a.currentTarget.classList.add("dragging"),T=document.createElement("div"),T.className="drag-ghost",T.innerHTML=`<div style="font-weight: bold; font-size: 12px;">${s}</div>`,T.style.backgroundColor=i,document.body.appendChild(T),Y(a);const n=r=>{let d,h;r instanceof MouseEvent?(d=r.clientX,h=r.clientY):(d=r.touches[0].clientX,h=r.touches[0].clientY),Y({clientX:d,clientY:h})},o=r=>{let d,h;r instanceof MouseEvent?(d=r.clientX,h=r.clientY):(d=r.changedTouches[0].clientX,h=r.changedTouches[0].clientY),ut(d,h),document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",o),document.removeEventListener("touchmove",n),document.removeEventListener("touchend",o)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",o),document.addEventListener("touchmove",n,{passive:!1}),document.addEventListener("touchend",o)}function Y(a){T&&(T.style.left=a.clientX+"px",T.style.top=a.clientY+"px")}function ut(a,t){if(!P||!c||!y)return;if(B&&M){const e=y.getBoundingClientRect();if(a>=e.left&&a<=e.right&&t>=e.top&&t<=e.bottom){const n=y.width/e.width,o=y.height/e.height,r=(a-e.left)*n,d=(t-e.top)*o,h=Math.floor(r/l.TILE_SIZE),u=Math.floor(d/l.TILE_SIZE),g=h-M.x,m=u-M.y;if(Math.abs(g)+Math.abs(m)===1){let p="down";g===1?p="right":g===-1?p="left":m===1?p="down":m===-1&&(p="up"),c.confirmDeployment(p)}}B=!1,M=null,N();return}const s=document.querySelector(".sell-zone");if(s){const e=s.getBoundingClientRect();if(a>=e.left&&a<=e.right&&t>=e.top&&t<=e.bottom){w&&c.sellBenchOperator(w),N();return}}const i=y.getBoundingClientRect();if(a>=i.left&&a<=i.right&&t>=i.top&&t<=i.bottom){const e=y.width/i.width,n=y.height/i.height,o=(a-i.left)*e,r=(t-i.top)*n,d=Math.floor(o/l.TILE_SIZE),h=Math.floor(r/l.TILE_SIZE);w&&c.tryPlaceOperator(w,d,h)}N()}function N(){P=!1,w=null,B=!1,M=null,T&&(T.remove(),T=null),document.querySelectorAll(".bench-card.dragging, .shop-card.dragging").forEach(a=>{a.classList.remove("dragging")})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",it):it();function it(){if(X=document.getElementById("start-screen"),x=document.getElementById("app-root"),U=document.getElementById("btn-start-game"),!X||!x||!U){console.error("无法找到必要的DOM元素");return}U.addEventListener("click",()=>{wt()})}
